<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="phaser-master/build/phaser.js"></script>
    </head>
    <body>
    <script type="text/javascript">

    window.onload = function() 
    {

        var game = new Phaser.Game(1280, 800, Phaser.AUTO, '', {preload: preload, create: create, update: update, render: render});   

        function preload () {

            game.load.spritesheet('girl', 'img/girl_spritesheet_idle.png',140,139);
            game.load.spritesheet('ghost', 'img/shade_spritesheet_idle.png',200,300);
            game.load.spritesheet('ghost', 'img/shade_spritesheet_idle.png',184,276);
            game.load.spritesheet('floor', 'img/holdbg.png');
            game.load.spritesheet('mouse', 'img/mouse.png', 225, 113, 12);
            game.load.spritesheet('bird', 'img/normal_bird_spritesheet.png',155,150);
            game.load.image('gtile1','img/groundtile1.png');
            game.load.image('gtile2','img/groundtile2.png')
            game.load.image('bgg','img/bgg.png');
        }
        //Globals vars
        var spriteLayer, midGroundLayer, backgroundLayer;
        var bg;
        var ghostLayer;
        var ghost, girl, mouse, bird;
        var floor;
        var cursors, wasd, jumpButton;
        var ghostSpeed = 250;
        var ghostSpeed = 2;
        var girlSpeed = 300;
        var jumpTimer = 0;
        var gtile1, gtile2, gtile3, gtile4, gtile5;
        var bgg;

        var ghostFacing = "right";
        var girlFacing = "left";
        var ghostFacing = 'right';
        var girlFacing = 'right';
        var birdMaxX = 700;
        var birdMin = 300;
        var birdSpeed = 200;

        function create () {
            //Current Game information
            game.world.setBounds(0,0,2560,800)
            game.stage.backgroundColor='#163233';
            game.physics.arcade.gravity.y = 450;
            bgg = game.add.sprite(0,0,'bgg');
            game.physics.enable(bgg, Phaser.Physics.ARCADE);
            bgg.body.allowGravity = false;
            bgg.collideWorldBounds = true;
            //ADD OBJECTS TO THE STAGE, START ANIMATIONS
            //initialize sprite layer
            spriteLayer = game.add.group();
            spriteLayer.enableBody = true;
            spriteLayer.physicsBodyType = Phaser.Physics.ARCADE;            
            spriteLayer.collideWorldBounds = true;
            //floor of level init
            floor = game.add.tileSprite(0,800-195,1280,800,'floor');
            game.physics.enable(floor,Phaser.Physics.ARCADE);
            floor.body.immovable = true;
            floor.body.allowGravity = false;
            //ground tile loading and placement
            midGroundLayer = game.add.group();
            midGroundLayer.enableBody = false;
            midGroundLayer.physicsBodyType = Phaser.Physics.ARCADE;
            gtile1 = midGroundLayer.create(0,575,'gtile1');
            gtile2 = midGroundLayer.create(320,575,'gtile2');
            gtile3 = midGroundLayer.create(640,575,'gtile1');
            gtile4 = midGroundLayer.create(960,575, 'gtile2');
            //bird init
            bird = spriteLayer.create(800, game.world.centerY, 'bird');
            bird.animations.add('birdIdle', [0,1,2] ,6,true);
            bird.anchor.setTo(.5,1);
            bird.body.gravity.y=0;
            bird.body.allowGravity=false;
            bird.animations.play('birdIdle');
            //girl init
            girl = spriteLayer.create(game.world.x = 50,game.world.centerY, 'girl');  
            girl.animations.add('girlIdle', [0,1,2,2,1,0] ,4);    
            girl.anchor.setTo(.5,1);      
            girl.animations.play('girlIdle');
            girl.animations.play('birdIdle');
            //ghost layer init
            ghostLayer = game.add.group();
            ghostLayer.enableBody = true;
            ghostLayer.physicsBodyType = Phaser.Physics.ARCADE;
            ghostLayer.collideWorldBounds = true;
            //ghost init
            ghost = ghostLayer.create(game.world.centerX, game.world.centerY, 'ghost');
            ghost.collideWorldBounds = true;
            ghost.animations.add('idle', [0,1,2,3,4], 7, true);
            ghost.anchor.setTo(.5,1);
            ghost.animations.play('idle');
            ghost.body.gravity.y = 0;
            ghost.body.allowGravity = false;
            //mouse init
            mouse = spriteLayer.create(300,100, 'mouse');
            mouse.scale.set(0.5,0.5);
            mouse.animations.add('nice',[0,1,2,3,2,1]);
            mouse.animations.add('angry',[4,5,6,7,6,5]);
            mouse.animations.add('ghost',[8]);
            mouse.animations.play('nice', 4, true);
            //girl in focus
            game.camera.follow(girl);


            //alias input systems to references
            cursors = game.input.keyboard.createCursorKeys();
            jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR); 
            wasd = {
                up: game.input.keyboard.addKey(Phaser.Keyboard.W),
                down: game.input.keyboard.addKey(Phaser.Keyboard.S),
                left: game.input.keyboard.addKey(Phaser.Keyboard.A),
                right: game.input.keyboard.addKey(Phaser.Keyboard.D)
            };

        }

        function render(){
        }

        function update()
        {
            //game.physics.arcade.collide(ghostLayer,floor);
            if(game.physics.arcade.collide(spriteLayer,floor))
            {
                girl.floored = true;
            } else {
                girl.floored = false;
            }
            //Ghost Movement Decision Tree
            if(cursors.left.isDown){
                ghost.x -= ghostSpeed;
                ghostFacing = 'left';
                ghost.scale.x=-1;
            }
            if(cursors.right.isDown){
                ghost.x += ghostSpeed;
                ghostFacing = 'right';
                ghost.scale.x=1;
            }
            if(cursors.up.isDown){
                ghost.y -= ghostSpeed;
                ghostFacing = 'up';
            }
            if(cursors.down.isDown){
                ghost.y +=ghostSpeed;
                ghostFacing = 'down';
            }

            //bird movement

            //mouse movement and decision logic
            var ghostDist = (ghost.x - mouse.body.x);
            var dist = girl.body.x - mouse.body.x;
            mouse.body.acceleration.x = dist;
            if(mouse.scale.x > 0 && mouse.body.velocity.x > 0) mouse.scale.x *=-1;
            if(mouse.scale.x < 0 && mouse.body.velocity.x < 0) mouse.scale.x *=-1;
            if(Math.abs(ghostDist) < 100) {
                mouse.body.acceleration.x = 0;
                mouse.body.velocity.x=0;
                mouse.animations.play('ghost',4,true);
            }
            else if(Math.abs(dist) < 100) {
                mouse.animations.play('angry',4,true);
            } else {
                mouse.animations.play('nice',4,true);
            }
            //Bird
            bird.body.velocity.x=0;
            if(bird.body.x >=birdMaxX && birdSpeed > 0){
                birdSpeed = (-birdSpeed);
                bird.scale.x=1;
            }
            else if(bird.body.x <= birdMin && birdSpeed < 0){
                birdSpeed = (-birdSpeed);
                bird.scale.x=-1;
            }
            bird.body.velocity.x +=birdSpeed;
            //Girl movement decision tree
            bgg.body.velocity.x = 0;
            if(wasd.left.isDown){
                girl.body.velocity.x = -girlSpeed;
                girlFacing = 'left';
                girl.scale.x=-1;
                if(game.camera.x > 0){
                    bgg.body.velocity.x =- girlSpeed/5
                }
            }
            if(wasd.right.isDown){
                girl.body.velocity.x = girlSpeed;
                girlFacing = 'right'
                girl.scale.x=1;
                if(game.camera.x > 0){
                    bgg.body.velocity.x =+ girlSpeed/5
                }
            }
            if(wasd.down.isDown){
                girl.body.velocity.y = +girlSpeed;
                girlFacing = 'down';
            }
            if(girl.body.onFloor()) {
                console.log(girl.body.onFloor());
            }
            //jump!
            if (wasd.up.isDown && girl.floored && game.time.now > jumpTimer)
            {
                //console.log("Jumping");
                girl.body.velocity.y = -300;
                jumpTimer = game.time.now + 450;
            }

            if(girl.floored && Math.abs(girl.body.acceleration.x) < 0.01) {
                girl.body.velocity.x *= .60;
            }
            if(Math.abs(ghost.body.acceleration.x) < 0.01) {
                ghost.body.velocity.x *= .60;
            }
            if (girl.body.x >= 1280){
                
            }
        }


    };

    </script>

    </body>
</html>